# Maintainer: Jacob Hrke <kreyren@fsfe.org>
pkgname=u-boot-olimex-teres_i
pkgver=2023.10
pkgrel=3
pkgdesc="u-boot bootloader for OLIMEX Teres-I"
url="https://www.denx.de/wiki/U-Boot"
arch="aarch64"
license="GPL-2.0-or-later OFL-1.1 BSD-2-Clause BSD-3-Clause eCos-2.0 IBM-pibs
	ISC LGPL-2.0-only LGPL-2.1-only X11"

makedepends="
	arm-trusted-firmware
	bc
	bison
	crust-olimex-teres_i
	dtc
	flex
	gnutls-dev
	linux-headers
	openssl-dev
	py3-elftools
	py3-setuptools
	python3-dev
	swig
	util-linux-dev
	"
options="!check" # no tests
source="https://source.denx.de/u-boot/u-boot/-/archive/v$pkgver/u-boot-v$pkgver.tar.gz"

# shellcheck disable=SC2154 # srcdir is pre-defined
builddir="$srcdir/u-boot-v$pkgver"

build() {
	touch include/config.h
	LC_ALL=C date +'#define U_BOOT_DATE "%b %d %C%y"' > include/timestamp_autogenerated.h
	LC_ALL=C date +'#define U_BOOT_TIME "%T"' >> include/timestamp_autogenerated.h

	export BL31="/usr/share/arm-trusted-firmware/sun50i_a64/bl31.bin"
	export SCP="/usr/share/crust/olimex-teres_i/scp.bin"
	export BUILD_DIR="$builddir/build"

		make O="$BUILD_DIR" HOSTCC=gcc ARCH=arm teres_i_defconfig
		make O="$BUILD_DIR" HOSTCC=gcc ARCH=arm all
		sha512sum -b "$BUILD_DIR/u-boot-sunxi-with-spl.bin" > "$BUILD_DIR/u-boot-sunxi-with-spl.bin.sha512"
}

package() {
	# shellcheck disable=SC2154 # pkgdir is pre-defined
	install -Dm644 build/u-boot-sunxi-with-spl.bin \
		"$pkgdir"/usr/share/u-boot/olimex-teres_i/u-boot-sunxi-with-spl.bin

	install -D -m644 "build/u-boot-sunxi-with-spl.bin.sha512" \
		"$pkgdir/usr/share/u-boot/olimex-teres_i/u-boot-sunxi-with-spl.bin.sha512"
}


sha512sums="
67ba9e234a9f6d3208d6b40b335592c05e776fbd2519bc54566869de2ddfd17ad76b0351af7298832a5e090f8c3802383cc2e315446728962f106b7f159aec45  u-boot-v2023.10.tar.gz
"
